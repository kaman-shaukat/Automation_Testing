name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
permissions:
  pages: write 
  id-token: write

 
jobs:
  test:
    timeout-minutes: 60
    environment:
    name: github-pages
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test    
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/index.html
    - name: Setup Github Pages
      uses: actions/configure-pages@v5.0.0
    - name: Upload Artifact
      uses: actions/upload-pages-artifact@v3
      with:
       path: playwright-report/

    - name: Deploy Artifact to Github Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deploy to the github-pages environment
      run: echo {page_url} = ${{ steps.deployment.outputs.page_url}}

    - name: Send mail
      uses: dawidd6/action-send-mail@v3
      with:
                server_address: smtp.gmail.com
                server_port: 465
                secure: true
                username: ${{ secrets.MAIL_USER_EMAIL }}
                password: ${{ secrets.MAIL_USER_PASSWORD }}
                subject: Playwright Automation Execution Results
                to: ${{ secrets.MAIL_TO }}
                from: ${{ secrets.MAIL_FROM }}
                body: Build job of ${{github.repository}} completed successfully!
                html_body: |
                  <html>
                    <body>
                        <p>The playwright automation test job <strong>${{ github.repository }}</strong> completed successfully!</p>
                        <p>You can view the automation results deployed site at: <a href="${{ steps.deployment.outputs.page_url }}">${{ steps.deployment.outputs.page_url }}</a></p>
                    </body>
                  </html>
                ignore_cert: false
                convert_markdown: true
                priority: normal  

